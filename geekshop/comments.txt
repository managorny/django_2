* Урок 1.
Mac OS.
Сделал venv через Pycharm, скрины в папке screenshots. Виртуалки через терминал до этого также создавал на Linux.
Сделал алиас на запуск сервера в .bash_profile.
Сделал контекстный процессор в корзине.
Для отправки почты в методах модели хотел использовать datetime.datetime.now(). Но получил ошибку, очевидно из-за таймзоны. Пофиксил.
Добавил свой генератор соли.
Понял, что не очень удобно когда сообщение не отправлено, при этом юзер создался. Пока не разбирался как сделать по другому.
Настроил изначально через smtp.gmail.com, но пока ошибки (Google блокирует вход под учеткой).
С smtp.mail.ru получилось. Скриншот в папке screenshots.
Также столкнулся с проблемой неуникальности email, ссылка верификации становится не рабочей, т.к. возвращается не один юзер.
Хотел сделать уведомление об отправке в виде js-ного alert а главной странице, но решил, что не стоит наделять главную стр. тем, чем не нужно,
в итоге сделал через шаблон.

------------------------------------------------------------------------------------------------------------------------

* Урок 2.
Добавил очистку activation_key после первой удачной верификации (user.activation_key = '' в authapp.views)
Сделал авторизацию через Google.
Сделал авторизацию через ВКонтакте. Однако заметил, что после авторизации логин в базе с каким-то доп. набором символов.
Добавил профиль.
Добавил редактирование пользователя с 2мя формами (обычная и профиль).
Добавил сигнал на сохранение профиля при создании либо изменении юзера.
Сделал расширенную регистрацию из соцсетей через pipeline. При регистрации через Google пока добавил в aboutMe ссылку на картинку пользователя Google.
Добавил также расширенное для ВК, не увидел там информации: возвраст, обо мне, пол. Возможно зависит от аккаунта, на всякий случай оставил.
Добавил сбор screen_name и хотел email, но понял потом, что он и так собирается.
Ошибку AuthForbidden вызвал. Скриншот в папке screenshots.
Столкнулся с проблемой одинаковых username если из 2х соцсетей регестрироваться (в случае с pipeline username из ВК без доп. символов создается).
------------------------------------------------------------------------------------------------------------------------

* Урок 3.

Добавил всплывающее меню без бутстрапа, т.к. почему-то он все равно переопределяет мои стили и делает оступы у всей страницы по другому.
Добавил полный CRUD для ordersapp.
Добавил изменение статуса после совершения покупки.
------------------------------------------------------------------------------------------------------------------------

* Урок 4.
Добавил изменение остатков товаров, выбрал через сигналы.
Было следующее приключение:
---
Нашел проблему когда товара на складе 1 штука, тогда выпадает ошибка:
 "IntegrityError at /orders/order/create/ CHECK constraint failed: mainapp_product", - очевидно ошибка при работе с базой.
Подумал, что т.к. у нас перед сохранением нового заказа на складе уже числится 0 товара, и мы пытаемся из него вычесть кол-во, при этом из корзины еще не удалили.
Т.е. при сохранении заказа, сначала должно срабатывать удаление из корзины, затем уже сохранение товара...
Однако если будет ошибка при сохранении заказа, корзина уже будет удалена.
Предполагаю, что лучше не делать увеличение остатка при удалении корзины если на складе уже 0,
и уменьшение остатка при сохранении заказа, если также на складе уже 0 (т.к. при создании корзины уже удалили со склада).
Далее понял, что дело не только в 0, но и во всех случаях, когда кол-во товара в заказе больше остатка. Поэтому добавил условие не с 0, а со сравнением этих чисел.
И делаю так, что не пытаюсь еще раз вычесть кол-во товара заказа из остатка, т.к. это уже сделано при создании корзины,
в случае, когда остаток меньше либо равен кол-ву товара в заказе.
---
Кажется, что вообще не нужно делать повторного вычетания при сохранении заказа, если это уже сделано при создании корзины.
Но пока не уверен, что все продумал. Т.к. корзина может жить долго, надо будет подумать дальше над вариантами поведения.

Добавил JQuery и django-dynamic-formset. Добавил начало переделки файла с JQuery на чистый JS.
Начал "делать" обновление цены в зависимости от выбранного товара и его кол-ва.
Пока сделал только переопределение переменных с товарами, кол-вом и ценами.
Пока начал с плана.
План:
1) сохранять все изначально загруженные товары и их атрибуты (кол-во и цена).
    Предполагается, что будет 3 массива, товары(str(name) или int в случае, если решу делать через id), кол-во(int), цены(float):
        [товар1, товар2, ...], [кол-во товара1, кол-во товара2, ...], [цена товара1, цена товара 2, ...]
2) переопределять переменные с уже загруженными товарами и их атрибутами, если товар либо его атрибуты поменялись.
3) добавлять в переменные новые товары.
4) делать запрос на получение цены для нового товара.
5) обновлять общую стоимость и общее кол-во товаров заказа.
6) добавить проверку общего кол-ва товара на складе и не давать брать сколько угодно товара, а столько сколько сейчас в базе.

В момент когда переделал _price на получение текста через document.querySelector , почему-то пропали кнопки "добавить продукт" и "удалить".
Вероятно из-за ошибки "Uncaught TypeError: Cannot read property 'outerText' of null", т.к. текст еще не загрузился, и поэтому null.
Добавил условие, забирать текст, когда этот span уже загрузился.
------------------------------------------------------------------------------------------------------------------------

* Урок 5.

1. Добавил подтягивание цены при выборе товара. Сделал, чтобы кол-во товара было не 0, а 1, раз появляется цена, то возможно логичнее сразу кол-во товара 1.
2. Добавил, чтобы неактивные товары нельзя было выбирать.
3. Перенес проект на хостинг. Pycharm CE, поэтому использовал scp для переноса файлов.
4. Хотел на python3.8 завести все. Все равно пришлось поставить все в python3.6, который был по умолчанию в Ubuntu 18.04, т.к. gunicorn встал там откуда не видел установленный Django в python3.8.
------------------------------------------------------------------------------------------------------------------------

* Урок 6.

1. Сделал dumpdata по приложениям. Попытался установить PostgreSQL, но получил ошибку при попытке зайти из-под юзера
Ошибка такая: "could not change directory to "/root": Permission denied
psql: could not connect to server: No such file or directory
	Is the server running locally and accepting
	connections on Unix domain socket "/var/run/postgresql/.s.PGSQL.5432"?"
Также проверил папку postgresql в /etc и в /var/lib , они пустые. При этом установка прошла с ошибкой (см. скриншот).
Выполнил рекомендуемую команду для запуска кластера вручную. Все заработало.
Заполнил базу.
Запустил.

2. Поставил django-debug-toolbar (см. screenshots). Также django-debug-toolbar-template-profiler встал нормально вместе с wrapt.
Добавил оптимизации с урока.
Приключения:
Но почему-то select_related() не помог в корзине, как было 9 симилар и 6 дубликатов, так и осталось.
Сначала подумал, что очень странное поведение, добавил в same_products select_related() , открыл страницу http://127.0.0.1:8000/category/0/products/ ,
показывает 12 запросов, 5 симилар, 2 дубля. Все это в режиме инкогнито. Потом перезапустил проект, запросов стало 3 всего.
Тоже самое сделал с products_list_category , ничего не изменилось. Убрал select_related() везде, перезагрузил стр., тоже самое,
перезагрузил сервер, закрыл инкогнито, открыл заново, все равно 3 запроса...
После этого заметил, что 3 запроса выполняется, если не авторизовываться. Вероятно, часть доп. запросов прилетает из корзины.

3. Добавил django-extensions. Урлы в файле, ошибок в шаблонах 0.
4. Поставил pydotplus. С получением визуализации была проблема - "pydotplus.graphviz.InvocationException: GraphViz's executables not found".
Поставил GraphViz. Потом была "pydotplus.graphviz.InvocationException: GraphViz's executables not found".
Пока остановился на этом.
5. Запустил profileserver но появилась ошибка - "A server error occurred.  Please contact the administrator.".
Добавил в меню {% csrf_token %} , не помогло.
6. Поставил на Mac OS siege.
Не успел плотно поработать с siege.

Ниже список с результатами изменений (есть скриншот в папке screenshots). Сделал сколько успел.

стр                                                 кол-во до           кол-во после

http://127.0.0.1:8000/products/                 15 (4 sim)             12 (2 sim, 2 dub)
http://127.0.0.1:8000/category/0/products/      12 (5 sim, 2 dub)      9 (2 sim, 2 dub)
http://127.0.0.1:8000/orders/order/update/18/   68 (62 sim, 62 dub)    20 (14 sim, 14 dub)
------------------------------------------------------------------------------------------------------------------------

* Урок 7.

Ура. Заработал gunicorn в связке с nginx. Создал нового юзера и из-под него сделал.
Возможно до этого не работало, т.к. gunicorn ставился не туда из-под рута.
Т.к. при установке в новом озере gunicorn не сказал, что он уже установлен, и требовал наличие в домашней папке .local/lib .
Т.е. вероятно он ставится под юзера и смотрит внутри, а у меня все было в папке root до этого, а где был gunicorn неизвестно.
Поработал с siege, добился 100% с login_required. Добавил login_url в siege.config.
При 170 запросах - «The server is now under siege...Killed».
При 128 запросах:
Transactions:		       28018 hits
Availability:		      100.00 %
Elapsed time:		      360.11 secs
Data transferred:	      593.35 MB
Response time:		        1.58 secs
Transaction rate:	       77.80 trans/sec
Throughput:		        1.65 MB/sec
Concurrency:		      122.69
Successful transactions:       27634
Failed transactions:	           0
Longest transaction:	       58.61
Shortest transaction:	        0.00

После db_index при 128 запросах:
Transactions:		       27876 hits
Availability:		      100.00 %
Elapsed time:		      293.77 secs
Data transferred:	      579.13 MB
Response time:		        1.28 secs
Transaction rate:	       94.89 trans/sec
Throughput:		        1.97 MB/sec
Concurrency:		      121.32
Successful transactions:       27492
Failed transactions:	           0
Longest transaction:	       53.88
Shortest transaction:	        0.00

Добавлен @cached_property, в корзине больше нет similar и duplicate.

Добавил в заказы в шаблон summary работу с with.
На заказе http://127.0.0.1:8000/orders/order/update/18/ до этого было 20 запросов (14 sim, 14 dupl), после with стало 17 (11 sim, 8 dupl).
siege показал (общий по всем урлам):
При 128 запросах:
Transactions:		       19576 hits
Availability:		      100.00 %
Elapsed time:		      193.58 secs
Data transferred:	      382.74 MB
Response time:		        1.17 secs
Transaction rate:	      101.13 trans/sec
Throughput:		        1.98 MB/sec
Concurrency:		      118.26
Successful transactions:       19320
Failed transactions:	           0
Longest transaction:	       38.95
Shortest transaction:	        0.00

Тест без низкоуровневого кэширования на новом списке urls_2 (с тем кол-вом переходов на стр. как при прогревании кэша):
$ siege -f urls_2.txt -d0 -r46 -c128
** SIEGE 4.0.4
** Preparing 128 concurrent users for battle.
The server is now under siege...
Transactions:		       50924 hits
Availability:		      100.00 %
Elapsed time:		      159.58 secs
Data transferred:	      559.24 MB
Response time:		        0.40 secs
Transaction rate:	      319.11 trans/sec
Throughput:		        3.50 MB/sec
Concurrency:		      126.57
Successful transactions:       50924
Failed transactions:	           0
Longest transaction:	       11.00
Shortest transaction:	        0.00

Тест с низкоуровневым кэшированием на новом списке urls_2 (с прогретым кэшем):
Transactions:		       50920 hits
Availability:		      100.00 %
Elapsed time:		      118.39 secs
Data transferred:	      558.17 MB
Response time:		        0.29 secs
Transaction rate:	      430.10 trans/sec
Throughput:		        4.71 MB/sec
Concurrency:		      126.14
Successful transactions:       50920
Failed transactions:	           0
Longest transaction:	        4.48
Shortest transaction:	        0.00

Самая долгая транзакция сократилась почти в 3 раза.

Добавил кэширование фрагмента шаблона в orders_form.
Поиграл с кэшированием контроллеров и кэшированием сайта. Оставил кэширование контактов через диспетчер адресов.
Страница контактов загружается  (было 328.897 мс, стало 84.869 мс).

Общий итог по основному списку urls (с уже прогретым кэшем):
Transactions:		       15738 hits
Availability:		      100.00 %
Elapsed time:		       31.66 secs
Data transferred:	      266.62 MB
Response time:		        0.17 secs
Transaction rate:	      497.09 trans/sec
Throughput:		        8.42 MB/sec
Concurrency:		       84.99
Successful transactions:       15610
Failed transactions:	           0
Longest transaction:	        3.15
Shortest transaction:	        0.00

Видим разницу в улучшении в разы. Общее время выполнения в 6 раз сократилось.

Однако если считать с кэшем в orders_form, то при еще 2х повторных запусках время немного увеличилось:
Transactions:		       15726 hits
Availability:		      100.00 %
Elapsed time:		       56.79 secs
Data transferred:	      265.79 MB
Response time:		        0.37 secs
Transaction rate:	      276.91 trans/sec
Throughput:		        4.68 MB/sec
Concurrency:		      101.37
Successful transactions:       15598
Failed transactions:	           0
Longest transaction:	        9.57
Shortest transaction:	        0.00

Через еще несколько повторов пошло нечто странное, как будто кэш не работает или VDS стала нагруженной:
Transactions:		       15625 hits
Availability:		       99.83 %
Elapsed time:		      198.17 secs
Data transferred:	      262.55 MB
Response time:		        1.49 secs
Transaction rate:	       78.85 trans/sec
Throughput:		        1.32 MB/sec
Concurrency:		      117.82
Successful transactions:       15511
Failed transactions:	          27
Longest transaction:	       62.71
Shortest transaction:	        0.00
